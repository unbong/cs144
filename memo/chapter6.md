# 第六章 路由

## 泛红路由和生成树

## Bellman Ford 生成树
* 在一个路由结构中，某一个路由与其他路由的连通的最小成本为路由的最小生成树
    * 算法
        * 假设到其他路由的成本为无限大
        * 更新从某一个路由开始到其他路由的值到生成树的表格中
        * 从更新的路由中继续执行上述1 2 步骤。直到没有为止
* 需要所有的路由都有一个生成树，来管理与其他路由的连通成本
* 曾被使用在第一代路由中 被称为RIP

## Dijkstra
* 算法 
    * 将与起始点有连接的路由，由成本的小到大排序并写入到候选集合中
    * 从集合中找到成本最小的路由选出后，与起点连接称为森林。
    * 并将与森林有连接的路由，由成本的由小到大写入到候选集中
    * 再次选出成本最小的路由，连接为森林，不断执行至候选为空，并且所有的节点都被遍历到

## 路由 RIP OSPF
* 层级关系与自治系统（AS）
    * 自治系统与自治系统之间时通过通过外部网管协议通信（BGP4）， 所有内部的信息想要发送到外部时需要通过连接外部的网关。
    * 系统内部的路由使用内部路由协议（IRP）实现，IRP有多种，OSPF，ISIS。各个自治系统使用的IRP会不同。
    * 多个出口网管与单一出口网关的内部路由规则会有所不同
        * 单一出口网关
            * 每一个路由知道AS的前缀
            * 发送到别的as的包，默认发送大出口网关
            * 在单一出口网关中，路由表相对较小
        * 多个出口网关
            * 多用于企业中
            * 对于给定的目的地前缀，必须告诉每个内部路由使用哪个出口点
            * 需要大型路由表
            * 方法1: 热土豆路由-发送到最近的出口点
            * 方法2: 选择离目的地最近的出口


    * 找到as的指令
        * 使用dns命令找到某一域名的ip地址
            * dig “hostname”
        * nc指令找到对应ip所属的as
            * nc whois.cymru.com 43
            * ip地址
        
        * 或者使用 traceroute -a 域名地址

* 内部路由协议 IRP
    * RIP 
        * 使用距离向量（分布式BellmanFord）
        * Internet RFC2453
        * 每30秒发送更新
        * 对于更新无身份验证
        * BSDUnix中的原生路由
        * 现在很少使用
    * OSPF  
        * 使用泛洪发送链路状态的更新
        * Internet RFC2328
        * 每一个路由执行Dijkstra 算法
        * 对于更新有身份验证
        * 自治系统被参与到区域中
        * 广泛应用
        * ISIS是一个相似的

* 外部路由协议 BGP4
    * 每个as必须用BGP4相互连接
* 因特网的结构

## BGP 
* BGP使用Path Vector
* BGP路由发布完成的路径（AS的列表）
    * 
* 路径循环被本地侦测并无视
* 本地策略在选项中选择中意的路径
* 当链路或链接失败，路径会撤回

* BGP消息
    * OPEN
    * KEEP ALIVE
    * Notificatioin
    * Update

    * BGP announcement = prefix + path attributes

    * path attributes：
        * 下一跳路由， ASPath ， 本地中意， 多出口辨别器

    ## 多播路由
    * 技术与原理
        * 反响路径广播（RPB）与剪枝
        * 一对多树
    * 实践
        * IGMP - 组管理
        * DVMRP 第一个多播路由协议
        * PIM 协议独立于多播

## 生成树协议
* 以太网关工作方式
    * 检测每个到达帧的头
    * 如果以太网终点地址在转发表内，则转发帧到正确的端口中。
    * 如果以太网终点地址不再转发表内，给所有的端口广播帧
    * 该表中的表项是通过检查到达报文的以太网源地址来学习的

* 学习可能会产生环
    * 产生环的话会将包无限的传递下去。

* 避免环（生成树协议）
    * 网关的拓扑结构是图
    * 生成树协议发现一个无环的所有节点的子图
    * 分布式协议决定
        * 哪一个网关是树的根
        * 哪一个端口允许沿着树转发包

* 如何工作
    * 1 首先所有的网关广播一个“桥接协议数据单元” （发送者ID，根的ID，发送者到根的距离）
    * 2 开始，所有网关生成自己为根，距离为0 
    * 3 每个网关广播直到听到一个更好的消息
        * 一个根的id更小
        * 一个根的ID相同，但是距离更小
        * 发送者id越小关系越差
    * 4 如果网关听到更好的消息，重传该消息（加1 距离）
    * 根端口：距离根最近的网关端口
    * 指定的端口：端口的邻居同意使用并转发至根，所有其他端口则关闭转发
    * 最终
        * 只有根组织配置消息（其他重传）
        * 本地，网关只在端口上转发
